<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡§è‡§°‡§µ‡§æ‡§Ç‡§∏‡•ç‡§° ‡§™‡•â‡§á‡§Ç‡§ü-‡§ü‡•Ç-‡§™‡•â‡§á‡§Ç‡§ü ‡§Æ‡§æ‡§™‡§® ‡§â‡§™‡§ï‡§∞‡§£</title>
    <style>
        /* --- 1. ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤-‡§Æ‡•Å‡§ï‡•ç‡§§ UI ‡§î‡§∞ ‡§≤‡•á‡§Ü‡§â‡§ü --- */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            background-color: #f0f2f5;
            color: #333;
            overflow: hidden; /* ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§π‡§ü‡§æ‡§§‡§æ ‡§π‡•à */
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 10px 0;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        #main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto; /* ‡§Ø‡§¶‡§ø ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§¨‡§π‡•Å‡§§ ‡§¨‡§°‡§º‡•Ä ‡§π‡•ã ‡§§‡•ã ‡§Ü‡§Ç‡§§‡§∞‡§ø‡§ï ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ */
        }
        #control-panel {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px 0;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }

        /* --- 2. ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã/‡§ï‡•à‡§®‡§µ‡§∏ ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ --- */
        #video-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 4px solid #007bff;
            border-radius: 12px;
            overflow: hidden;
            background: black;
            min-height: 250px; /* ‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§¶‡•É‡§∂‡•ç‡§Ø‡§§‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è */
            touch-action: none; /* ‡§ü‡§ö ‡§á‡§µ‡•á‡§Ç‡§ü‡•ç‡§∏ ‡§ï‡•ã ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§ø‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
        }
        #video, #canvas {
            width: 100%;
            height: 100%;
            object-fit: contain; /* ‡§∏‡•Å‡§®‡§ø‡§∂‡•ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡§§‡§æ ‡§π‡•à ‡§ï‡§ø ‡§´‡§º‡•Ä‡§° ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•á ‡§≠‡•Ä‡§§‡§∞ ‡§´‡§ø‡§ü ‡§π‡•ã ‡§ú‡§æ‡§è */
            display: block;
        }
        #canvas {
            cursor: crosshair;
        }

        /* --- 3. ‡§¨‡§ü‡§® ‡§î‡§∞ ‡§á‡§®‡§™‡•Å‡§ü --- */
        button, input[type="number"], select {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ccc;
            cursor: pointer;
        }
        #testButton { background-color: #ffc107; color: #333; border: none; }
        #captureButton { background-color: #007bff; color: white; border: none; }
        #resetButton { background-color: #dc3545; color: white; border: none; }

        /* --- 4. ‡§ï‡•ç‡§∞‡•â‡§∏‡§π‡•á‡§Ø‡§∞ ‡§™‡•â‡§á‡§Ç‡§ü‡§∞ (50% ‡§µ‡§ø‡§ú‡§ø‡§¨‡§ø‡§≤‡§ø‡§ü‡•Ä) --- */
        .point {
            position: absolute;
            width: 30px; /* ‡§¨‡§°‡§º‡§æ ‡§∏‡§æ‡§á‡§ú‡§º */
            height: 30px;
            background-color: transparent;
            border: none;
            opacity: 0.5; /* 50% ‡§µ‡§ø‡§ú‡§ø‡§¨‡§ø‡§≤‡§ø‡§ü‡•Ä */
            pointer-events: none; /* ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡•ã ‡§™‡•â‡§á‡§Ç‡§ü ‡§ï‡•á ‡§™‡•Ä‡§õ‡•á ‡§™‡§æ‡§∏ ‡§ï‡§∞‡§®‡•á ‡§¶‡•á‡§§‡§æ ‡§π‡•à */
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .point::before, .point::after {
            content: '';
            position: absolute;
            background-color: red;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .point::before { /* ‡§µ‡§∞‡•ç‡§ü‡§ø‡§ï‡§≤ ‡§≤‡§æ‡§á‡§® */
            width: 3px;
            height: 100%;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }
        .point::after { /* ‡§π‡•â‡§∞‡§ø‡§ú‡•â‡§®‡•ç‡§ü‡§≤ ‡§≤‡§æ‡§á‡§® */
            width: 100%;
            height: 3px;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        .point.moving {
            opacity: 0.8; /* ‡§°‡•ç‡§∞‡•à‡§ó ‡§ï‡§∞‡§§‡•á ‡§∏‡§Æ‡§Ø ‡§ú‡§º‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§µ‡§ø‡§ú‡§ø‡§¨‡§ø‡§≤‡§ø‡§ü‡•Ä */
            cursor: grabbing;
        }
        
        /* --- 5. ‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡•á‡§ï‡•ç‡§∂‡§® --- */
        #reference-section {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        #result {
            margin-top: 10px;
            padding: 10px;
            font-size: 1.1em;
            background-color: #e2f0e6;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <header>
        <h1>üìê ‡§™‡•â‡§á‡§Ç‡§ü ‡§Æ‡§æ‡§™‡§® ‡§â‡§™‡§ï‡§∞‡§£</h1>
    </header>

    <div id="main-content">
        <div id="reference-section">
            <p style="margin-bottom: 5px;">‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡§æ‡§á‡§ú‡§º:
                <input type="number" id="refSize" placeholder="‡§â‡§¶‡§æ: 5" value="5" min="0.1" style="width: 60px;">
                <select id="unit">
                    <option value="cm">cm</option>
                    <option value="inch">inch</option>
                </select>
                <button id="setRefButton" disabled>‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
            </p>
        </div>

        <div id="video-container">
            <video id="video" autoplay playsinline style="display:none;"></video>
            <canvas id="canvas" style="display:none;"></canvas>
            </div>

        <p id="result">‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è '‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç' ‡§¶‡§¨‡§æ‡§è‡§Å‡•§</p>
    </div>

    <div id="control-panel">
        <button id="testButton">‚ö° ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
        <button id="captureButton" style="display:none;">‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡•á‡§Ç</button>
        <button id="resetButton" style="display:none;">‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</button>
    </div>
    
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const testButton = document.getElementById('testButton');
        const captureButton = document.getElementById('captureButton');
        const resetButton = document.getElementById('resetButton');
        const setRefButton = document.getElementById('setRefButton');
        const result = document.getElementById('result');
        const videoContainer = document.getElementById('video-container');
        const refSizeInput = document.getElementById('refSize');
        const unitSelect = document.getElementById('unit');

        let points = [];
        let referencePoints = [];
        let isCaptured = false;
        let conversionFactor = null;
        let measuringReference = false;
        let activePoint = null; // ‡§°‡•ç‡§∞‡•à‡§ó ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§™‡•â‡§á‡§Ç‡§ü

        // --- ‡§Ø‡•Ç‡§ü‡§ø‡§≤‡§ø‡§ü‡•Ä ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§®‡•ç‡§∏ ---

        // ‡§ï‡•à‡§®‡§µ‡§∏ ‡§™‡§ø‡§ï‡•ç‡§∏‡•á‡§≤ ‡§ï‡•ã UI ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§ ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç (‡§™‡•â‡§á‡§Ç‡§ü ‡§≤‡§ó‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è)
        function toUIPosition(x, y) {
            const rect = canvas.getBoundingClientRect();
            const left = ((x / canvas.width) * rect.width) + rect.left;
            const top = ((y / canvas.height) * rect.height) + rect.top;
            
            // ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•á ‡§∏‡§æ‡§™‡•á‡§ï‡•ç‡§∑ ‡§™‡•ç‡§∞‡§§‡§ø‡§∂‡§§
            const containerRect = videoContainer.getBoundingClientRect();
            return {
                left: ((left - containerRect.left) / containerRect.width) * 100,
                top: ((top - containerRect.top) / containerRect.height) * 100
            };
        }

        // UI ‡§á‡§µ‡•á‡§Ç‡§ü ‡§™‡•ã‡§ú‡§º‡•Ä‡§∂‡§® ‡§ï‡•ã ‡§ï‡•à‡§®‡§µ‡§∏ ‡§™‡§ø‡§ï‡•ç‡§∏‡•á‡§≤ ‡§Æ‡•á‡§Ç ‡§¨‡§¶‡§≤‡•á‡§Ç
        function toCanvasPosition(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        // --- 1. ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§î‡§∞ ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§≤‡•â‡§ú‡§ø‡§ï (‡§™‡§π‡§≤‡•á ‡§ú‡•à‡§∏‡§æ) ---

        function startCamera() {
             //... (‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§≤‡•â‡§ú‡§ø‡§ï ‡§Ø‡§π‡§æ‡§Å) ...
             if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                result.textContent = '‚ö†Ô∏è ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ‡§Ü‡§™‡§ï‡§æ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ MediaDevices API ‡§ï‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞‡§§‡§æ ‡§π‡•à‡•§';
                return;
            }

            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then((stream) => {
                    video.srcObject = stream;
                    video.style.display = 'block';
                    testButton.style.display = 'none';
                    captureButton.style.display = 'inline-block';
                    setRefButton.disabled = false;
                    result.innerHTML = '‚úÖ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§∂‡•Å‡§∞‡•Ç! <b>‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§</b>';
                    canvas.style.display = 'none';
                    resetButton.style.display = 'none';
                    isCaptured = false;
                    points = [];
                    referencePoints = [];
                    document.querySelectorAll('.point').forEach(p => p.remove());
                })
                .catch((err) => {
                    console.error('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§µ‡§ø‡§´‡§≤ ‡§π‡•Å‡§Ü:', err);
                    result.innerHTML = 'üö´ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§è‡§ï‡•ç‡§∏‡•á‡§∏ ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§Ø‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§';
                });
        }
        testButton.addEventListener('click', startCamera);

        captureButton.addEventListener('click', () => {
            if (!video.srcObject) return;

            // ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§´‡•ç‡§∞‡•á‡§Æ ‡§ï‡•ã ‡§ï‡•à‡§®‡§µ‡§∏ ‡§™‡§∞ ‡§°‡•ç‡§∞‡§æ ‡§ï‡§∞‡•á‡§Ç
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // UI ‡§Ö‡§™‡§°‡•á‡§ü
            video.style.display = 'none';
            canvas.style.display = 'block';
            captureButton.style.display = 'none';
            resetButton.style.display = 'inline-block';
            isCaptured = true;
            
            videoContainer.style.maxWidth = canvas.width + 'px';
            videoContainer.style.height = (canvas.height * (videoContainer.clientWidth / canvas.width)) + 'px'; // ‡§ï‡§Ç‡§ü‡•á‡§®‡§∞ ‡§ï‡•Ä ‡§ä‡§Ç‡§ö‡§æ‡§à ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç

            result.innerHTML = '2. ‡§™‡§π‡§≤‡•á **‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡§æ‡§á‡§ú‡§º** ‡§∏‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è **‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç** ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§';
        });

        // --- 2. ‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§¨‡§ü‡§® ‡§≤‡•â‡§ú‡§ø‡§ï ---
        setRefButton.addEventListener('click', () => {
            if (!isCaptured) {
                result.textContent = '‡§™‡§π‡§≤‡•á ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§ï‡•à‡§™‡•ç‡§ö‡§∞ ‡§ï‡§∞‡•á‡§Ç!';
                return;
            }
            measuringReference = true;
            setRefButton.disabled = true;
            referencePoints = [];
            points = [];
            // ‡§™‡•Å‡§∞‡§æ‡§®‡•á ‡§™‡•â‡§á‡§Ç‡§ü ‡§π‡§ü‡§æ‡§è‡§Å
            document.querySelectorAll('.point').forEach(p => p.remove());
            // ‡§ï‡•à‡§®‡§µ‡§∏ ‡§™‡§∞ ‡§°‡•ç‡§∞‡§æ ‡§ï‡•Ä ‡§ó‡§à ‡§≤‡§æ‡§á‡§®‡•á‡§Ç ‡§π‡§ü‡§æ‡§è‡§Å
            redrawCanvas(); 
            result.textContent = '‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡§æ‡§á‡§ú‡§º ‡§ï‡•á ‡§≤‡§ø‡§è **‡§™‡§π‡§≤‡§æ ‡§™‡•â‡§á‡§Ç‡§ü** ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§';
        });

        // --- 3. ‡§™‡•â‡§á‡§Ç‡§ü ‡§Æ‡§æ‡§∞‡•ç‡§ï‡§ø‡§Ç‡§ó ‡§î‡§∞ ‡§°‡•ç‡§∞‡•à‡§ó‡§ø‡§Ç‡§ó ‡§≤‡•â‡§ú‡§ø‡§ï ---
        
        function markPoint(x, y, isRef = false) {
            const uiPos = toUIPosition(x, y);

            const pointDiv = document.createElement('div');
            pointDiv.className = 'point';
            pointDiv.style.left = uiPos.left + '%';
            pointDiv.style.top = uiPos.top + '%';
            pointDiv.dataset.type = isRef ? 'ref' : 'measure';
            pointDiv.dataset.index = (isRef ? referencePoints.length : points.length);

            videoContainer.appendChild(pointDiv);
            
            const pointData = { x, y, div: pointDiv };

            // ‡§°‡•ç‡§∞‡•à‡§ó ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç (‡§Æ‡§æ‡§â‡§∏ ‡§î‡§∞ ‡§ü‡§ö ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è)
            pointDiv.addEventListener('mousedown', startDrag);
            pointDiv.addEventListener('touchstart', startDrag, { passive: false });

            return pointData;
        }
        
        // ‡§ï‡•à‡§®‡§µ‡§∏ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§á‡§µ‡•á‡§Ç‡§ü
        canvas.addEventListener('click', (event) => {
            if (!isCaptured || activePoint) return; 

            const {x, y} = toCanvasPosition(event.clientX, event.clientY);

            if (measuringReference) {
                if (referencePoints.length < 2) {
                    referencePoints.push(markPoint(x, y, true));
                    result.textContent = referencePoints.length === 1 ? '‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡§æ‡§á‡§ú‡§º ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡•Ç‡§∏‡§∞‡§æ ‡§™‡•â‡§á‡§Ç‡§ü ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§' : '‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...';
                }
                if (referencePoints.length === 2) {
                    calculateReference();
                    measuringReference = false;
                }
            } else if (conversionFactor !== null) {
                if (points.length < 2) {
                    points.push(markPoint(x, y, false));
                    result.textContent = points.length === 1 ? '‡§Æ‡§æ‡§™‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¶‡•Ç‡§∏‡§∞‡§æ ‡§¨‡§ø‡§Ç‡§¶‡•Å ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§' : '‡§¶‡•Ç‡§∞‡•Ä ‡§Æ‡§æ‡§™‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...';
                }
                if (points.length === 2) {
                    calculateDistance();
                }
            } else {
                result.textContent = '‡§™‡§π‡§≤‡•á ‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡§æ‡§á‡§ú‡§º ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç!';
            }
        });

        // --- ‡§°‡•ç‡§∞‡•à‡§ó ‡§´‡§º‡§Ç‡§ï‡•ç‡§∂‡§Ç‡§∏ ---

        function startDrag(e) {
            e.preventDefault(); // ‡§ü‡§ö ‡§™‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤‡§ø‡§Ç‡§ó ‡§∞‡•ã‡§ï‡•á‡§Ç
            activePoint = e.currentTarget;
            activePoint.classList.add('moving');

            // ‡§™‡•â‡§á‡§Ç‡§ü ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            let pointArray = activePoint.dataset.type === 'ref' ? referencePoints : points;
            let index = parseInt(activePoint.dataset.index);

            // ‡§°‡•ç‡§∞‡•à‡§ó ‡§Æ‡•Ç‡§µ‡§Æ‡•á‡§Ç‡§ü ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞
            document.addEventListener('mousemove', dragPoint);
            document.addEventListener('touchmove', dragPoint, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function dragPoint(e) {
            if (!activePoint) return;
            e.preventDefault(); 
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const {x, y} = toCanvasPosition(clientX, clientY);
            const uiPos = toUIPosition(x, y);

            // UI ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            activePoint.style.left = uiPos.left + '%';
            activePoint.style.top = uiPos.top + '%';
            
            // ‡§°‡•á‡§ü‡§æ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            let pointArray = activePoint.dataset.type === 'ref' ? referencePoints : points;
            let index = parseInt(activePoint.dataset.index);
            pointArray[index].x = x;
            pointArray[index].y = y;
            
            // ‡§ï‡•à‡§®‡§µ‡§∏ ‡§î‡§∞ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ï‡•ã ‡§≤‡§æ‡§á‡§µ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
            redrawCanvas();
            if (activePoint.dataset.type === 'ref' && referencePoints.length === 2) {
                calculateReference(true); // ‡§ï‡•á‡§µ‡§≤ ‡§´‡•à‡§ï‡•ç‡§ü‡§∞ ‡§ï‡•Ä ‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç
            } else if (activePoint.dataset.type !== 'ref' && points.length === 2) {
                calculateDistance(true); // ‡§ï‡•á‡§µ‡§≤ ‡§¶‡•Ç‡§∞‡•Ä ‡§ï‡•Ä ‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç
            }
        }

        function endDrag() {
            if (!activePoint) return;
            activePoint.classList.remove('moving');
            activePoint = null;

            // ‡§á‡§µ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§∏‡§®‡§∞‡•ç‡§∏ ‡§π‡§ü‡§æ‡§è‡§Å
            document.removeEventListener('mousemove', dragPoint);
            document.removeEventListener('touchmove', dragPoint);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchend', endDrag);
            
            // ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç
            if (referencePoints.length === 2) calculateReference();
            if (points.length === 2) calculateDistance();
        }

        // --- 4. ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§∂‡§® ‡§î‡§∞ ‡§∞‡•Ä‡§°‡•ç‡§∞‡•â ‡§≤‡•â‡§ú‡§ø‡§ï ---
        
        function redrawCanvas() {
            context.drawImage(video, 0, 0, canvas.width, canvas.height); // ‡§á‡§Æ‡•á‡§ú ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§°‡•ç‡§∞‡§æ ‡§ï‡§∞‡•á‡§Ç

            // ‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§≤‡§æ‡§á‡§®
            if (referencePoints.length === 2) {
                const pR1 = referencePoints[0];
                const pR2 = referencePoints[1];
                context.beginPath();
                context.moveTo(pR1.x, pR1.y);
                context.lineTo(pR2.x, pR2.y);
                context.strokeStyle = 'yellow';
                context.lineWidth = 4;
                context.stroke();
            }

            // ‡§Æ‡§æ‡§™‡§® ‡§≤‡§æ‡§á‡§®
            if (points.length === 2) {
                const p1 = points[0];
                const p2 = points[1];
                context.beginPath();
                context.moveTo(p1.x, p1.y);
                context.lineTo(p2.x, p2.y);
                context.strokeStyle = 'lime';
                context.lineWidth = 4;
                context.stroke();
            }
        }

        function calculateDistance(live = false) {
            if (points.length !== 2) return;

            const p1 = points[0];
            const p2 = points[1];

            const distancePixels = Math.sqrt(
                Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2)
            );

            let output = `‚úÖ ‡§Æ‡§æ‡§™‡•Ä ‡§ó‡§à ‡§¶‡•Ç‡§∞‡•Ä: **${distancePixels.toFixed(2)} ‡§™‡§ø‡§ï‡•ç‡§∏‡•á‡§≤**`;

            if (conversionFactor !== null) {
                const distanceReal = distancePixels * conversionFactor;
                const selectedUnit = unitSelect.value;
                output += `<br>üìè **‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§≤‡§Ç‡§¨‡§æ‡§à:** **${distanceReal.toFixed(2)} ${selectedUnit}**`;
            } else {
                output += `<br><span style="color:red;">‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡§æ‡§á‡§ú‡§º ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ‡§§‡§æ‡§ï‡§ø ‡§Ø‡§π ‡§ó‡§£‡§®‡§æ ‡§ï‡§∞ ‡§∏‡§ï‡•á‡•§</span>`;
            }

            result.innerHTML = output;
            if (!live) redrawCanvas();
        }

        function calculateReference(live = false) {
            if (referencePoints.length !== 2) return;
            
            const pR1 = referencePoints[0];
            const pR2 = referencePoints[1];
            const refDistancePixels = Math.sqrt(
                Math.pow(pR2.x - pR1.x, 2) + Math.pow(pR2.y - pR1.y, 2)
            );
            
            const actualRefSize = parseFloat(refSizeInput.value);
            
            if (refDistancePixels > 0 && !isNaN(actualRefSize)) {
                conversionFactor = actualRefSize / refDistancePixels;
            } else {
                conversionFactor = null;
            }

            if (!live) {
                setRefButton.textContent = '‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡•á‡§ü ‚úÖ';
                setRefButton.disabled = true;
                result.innerHTML = `‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡•á‡§ü! ‡§Ö‡§¨ ‡§Æ‡§æ‡§™‡§® ‡§ï‡•á ‡§≤‡§ø‡§è **‡§¶‡•ã ‡§¨‡§ø‡§Ç‡§¶‡•Å** ‡§ö‡§ø‡§π‡•ç‡§®‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§`;
                redrawCanvas();
            }
        }
        
        // --- 5. ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ---
        resetButton.addEventListener('click', () => {
             //... (‡§∞‡•Ä‡§∏‡•á‡§ü ‡§≤‡•â‡§ú‡§ø‡§ï ‡§Ø‡§π‡§æ‡§Å) ...
             if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }

            points = [];
            referencePoints = [];
            conversionFactor = null;
            isCaptured = false;
            
            context.clearRect(0, 0, canvas.width, canvas.height);
            video.style.display = 'none';
            canvas.style.display = 'none';
            testButton.style.display = 'inline-block';
            captureButton.style.display = 'none';
            resetButton.style.display = 'none';
            setRefButton.disabled = false; // ‡§¨‡§ü‡§® ‡§ï‡•ã ‡§´‡§ø‡§∞ ‡§∏‡•á ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§ï‡§∞‡•á‡§Ç
            setRefButton.textContent = '‡§∞‡•á‡§´‡§∞‡•á‡§Ç‡§∏ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç';
            result.textContent = '‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ‡•§ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•á‡§∏‡•ç‡§ü ‡§¨‡§ü‡§® ‡§¶‡§¨‡§æ‡§è‡§Å‡•§';

            document.querySelectorAll('.point').forEach(p => p.remove());
        });
    </script>

</body>
</html>
